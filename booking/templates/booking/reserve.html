<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seat Reservation</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 2.5em; color: #e94560; }
        .movie-info, .seating-area {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .info-row { display:flex; justify-content:space-between; margin-bottom:15px; }
        .legend { display:flex; justify-content:center; gap:30px; margin-bottom:20px; }
        .legend-box { width:25px; height:25px; border-radius:5px; border:2px solid; }
        .available { background:white; border-color:white; }
        .reserved { background:#e94560; border-color:#e94560; }
        .selected { background:#2ecc71; border-color:#2ecc71; }
        .screen-label { text-align:center; margin-bottom:5px; font-weight:600; color:#e94560; }
        .screen {
            background:linear-gradient(to bottom,#e94560,#d63651);
            height:15px; border-radius:50% 50% 0 0;
            width:80%; margin:0 auto 30px;
        }
        .seat-grid {
            display:grid;
            grid-template-columns:repeat(5,1fr);
            gap:15px; max-width:500px; margin:0 auto;
        }
        .seat {
            aspect-ratio:1;
            border:2px solid #fff;
            border-radius:8px;
            font-weight:600;
            display:flex; justify-content:center; align-items:center;
            cursor:pointer;
        }
        .seat.available:hover { transform:scale(1.05); }
        .button-container { display:flex; justify-content:center; gap:20px; margin-top:25px; }
        button {
            padding: 15px 40px;
            border:none;
            border-radius:8px;
            font-size:1.1em;
            font-weight:600;
            cursor:pointer;
        }
        .btn-back { background:#6c757d; color:#fff; }
        .btn-next { background:#2ecc71; color:#fff; }
        .btn-next:disabled { background:#777; cursor:not-allowed; }
    </style>
</head>

<body>
<div class="container">

    <header><h1>üé¨ Seat Reservation</h1></header>

    <div class="movie-info">
        <div class="info-row">
            <label>Movie:</label>
            <span>{{ movie.title }}</span>
        </div>
        <div class="info-row">
            <label>Showtime:</label>
            <span>{{ showtime.date }} ‚Äî {{ showtime.time }}</span>
        </div>
        <div class="info-row">
            <label>Venue:</label>
            <span>{{ showtime.venue }}</span>
        </div>
    </div>

    <div class="legend">
        <div><div class="legend-box available"></div>Available</div>
        <div><div class="legend-box reserved"></div>Reserved</div>
        <div><div class="legend-box selected"></div>Selected</div>
    </div>

    <div class="seating-area">
        <div class="screen-label">SCREEN</div>
        <div class="screen"></div>
        <div id="seatGrid" class="seat-grid"></div>
    </div>

    <div class="selection-info">
        Selected Seat: <span id="selectedSeat">None</span>
    </div>

    <button class="btn-next" id="nextBtn" disabled onclick="reserveSeat()">Next ‚Üí</button>

</div>

<script>
    const showtimeId = "{{ showtime_id }}";
    const userId = "{{ request.user.id }}";

    let seats = [];
    let selectedSeats = [];  // MULTI-SEAT ARRAY

    async function loadSeats() {
        const res = await fetch(`/api/seats/${showtimeId}/`);
        seats = await res.json();
        renderSeats();
    }

    function renderSeats() {
        const grid = document.getElementById("seatGrid");
        grid.innerHTML = "";

        seats.forEach(seat => {
            const div = document.createElement("div");
            div.textContent = seat.seat_number;
            div.classList.add("seat");

            if (seat.is_taken) {
                div.classList.add("reserved");
            } else {
                div.classList.add("available");
                div.onclick = () => toggleSeat(seat.seat_number, div);
            }

            grid.appendChild(div);
        });
    }

    function toggleSeat(seatNumber, element) {
        if (selectedSeats.includes(seatNumber)) {
            selectedSeats = selectedSeats.filter(s => s !== seatNumber);
            element.classList.remove("selected");
            element.classList.add("available");
        } else {
            selectedSeats.push(seatNumber);
            element.classList.remove("available");
            element.classList.add("selected");
        }

        updateUI();
    }

    function updateUI() {
        const seatLabel = document.getElementById("selectedSeat");

        if (selectedSeats.length === 0) {
            seatLabel.textContent = "None";
            document.getElementById("nextBtn").disabled = true;
        } else {
            seatLabel.textContent = selectedSeats.join(", ");
            document.getElementById("nextBtn").disabled = false;
        }
    }

    async function reserveSeat() {
        const response = await fetch("/api/reserve/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                showtime_id: showtimeId,
                user_id: userId,
                seats: selectedSeats
            })
        });

        const result = await response.json();

        if (result.error) {
            alert(result.error);
            loadSeats();
            return;
        }

        window.location.href = "/payment/";
    }

    loadSeats(); // ‚Üê VERY IMPORTANT
</script>
